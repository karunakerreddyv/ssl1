# =============================================================================
# PostgreSQL Exporter Custom Queries
# Pravaha Platform - Single Server Deployment
# =============================================================================
#
# Custom queries for collecting Pravaha-specific PostgreSQL metrics.
# These queries extend the default postgres_exporter metrics.
#
# Query Format:
#   query: SQL query string
#   master: true if should only run on master (not replicas)
#   cache_seconds: how long to cache results
#   metrics: list of metric definitions
#
# =============================================================================

# =============================================================================
# Database Size Metrics
# =============================================================================
pg_database_size:
  query: |
    SELECT
      datname as database,
      pg_database_size(datname) as size_bytes
    FROM pg_database
    WHERE datname NOT IN ('template0', 'template1')
  master: true
  cache_seconds: 300
  metrics:
    - database:
        usage: "LABEL"
        description: "Name of the database"
    - size_bytes:
        usage: "GAUGE"
        description: "Database size in bytes"

# =============================================================================
# Table Size Metrics (Top Tables)
# =============================================================================
pg_table_size:
  query: |
    SELECT
      schemaname,
      relname as table_name,
      pg_total_relation_size(relid) as total_size_bytes,
      pg_relation_size(relid) as table_size_bytes,
      pg_indexes_size(relid) as indexes_size_bytes,
      n_live_tup as live_tuples,
      n_dead_tup as dead_tuples
    FROM pg_stat_user_tables
    ORDER BY pg_total_relation_size(relid) DESC
    LIMIT 50
  master: true
  cache_seconds: 300
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - table_name:
        usage: "LABEL"
        description: "Table name"
    - total_size_bytes:
        usage: "GAUGE"
        description: "Total size including indexes and toast"
    - table_size_bytes:
        usage: "GAUGE"
        description: "Table size without indexes"
    - indexes_size_bytes:
        usage: "GAUGE"
        description: "Size of all indexes on the table"
    - live_tuples:
        usage: "GAUGE"
        description: "Estimated number of live rows"
    - dead_tuples:
        usage: "GAUGE"
        description: "Estimated number of dead rows"

# =============================================================================
# Connection Statistics
# =============================================================================
pg_stat_activity_state:
  query: |
    SELECT
      datname as database,
      state,
      COUNT(*) as connections
    FROM pg_stat_activity
    WHERE datname IS NOT NULL
    GROUP BY datname, state
  master: true
  cache_seconds: 30
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - state:
        usage: "LABEL"
        description: "Connection state (active, idle, idle in transaction, etc.)"
    - connections:
        usage: "GAUGE"
        description: "Number of connections in this state"

# =============================================================================
# Long Running Queries
# =============================================================================
pg_stat_activity_long_running:
  query: |
    SELECT
      datname as database,
      usename as username,
      state,
      EXTRACT(EPOCH FROM (NOW() - query_start)) as duration_seconds,
      LEFT(query, 100) as query_prefix
    FROM pg_stat_activity
    WHERE state != 'idle'
      AND query_start IS NOT NULL
      AND NOW() - query_start > INTERVAL '5 minutes'
    ORDER BY duration_seconds DESC
    LIMIT 10
  master: true
  cache_seconds: 60
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - username:
        usage: "LABEL"
        description: "User running the query"
    - state:
        usage: "LABEL"
        description: "Query state"
    - query_prefix:
        usage: "LABEL"
        description: "First 100 characters of query"
    - duration_seconds:
        usage: "GAUGE"
        description: "Query duration in seconds"

# =============================================================================
# Lock Statistics
# =============================================================================
pg_locks_count:
  query: |
    SELECT
      datname as database,
      mode,
      COUNT(*) as lock_count
    FROM pg_locks l
    JOIN pg_database d ON l.database = d.oid
    WHERE d.datname NOT IN ('template0', 'template1')
    GROUP BY datname, mode
  master: true
  cache_seconds: 30
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - lock_count:
        usage: "GAUGE"
        description: "Number of locks of this type"

# =============================================================================
# Waiting Queries (Lock Contention)
# =============================================================================
pg_stat_activity_waiting:
  query: |
    SELECT
      datname as database,
      COUNT(*) as waiting_queries
    FROM pg_stat_activity
    WHERE wait_event_type IS NOT NULL
      AND state = 'active'
    GROUP BY datname
  master: true
  cache_seconds: 30
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - waiting_queries:
        usage: "GAUGE"
        description: "Number of queries waiting on locks"

# =============================================================================
# Vacuum Statistics
# =============================================================================
pg_stat_user_tables_vacuum:
  query: |
    SELECT
      schemaname,
      relname as table_name,
      COALESCE(EXTRACT(EPOCH FROM (NOW() - last_vacuum)), 0) as seconds_since_last_vacuum,
      COALESCE(EXTRACT(EPOCH FROM (NOW() - last_autovacuum)), 0) as seconds_since_last_autovacuum,
      vacuum_count,
      autovacuum_count
    FROM pg_stat_user_tables
    WHERE n_live_tup > 1000
    ORDER BY seconds_since_last_vacuum DESC
    LIMIT 50
  master: true
  cache_seconds: 300
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - table_name:
        usage: "LABEL"
        description: "Table name"
    - seconds_since_last_vacuum:
        usage: "GAUGE"
        description: "Seconds since last manual vacuum"
    - seconds_since_last_autovacuum:
        usage: "GAUGE"
        description: "Seconds since last autovacuum"
    - vacuum_count:
        usage: "COUNTER"
        description: "Number of manual vacuums"
    - autovacuum_count:
        usage: "COUNTER"
        description: "Number of autovacuums"

# =============================================================================
# Index Usage Statistics
# =============================================================================
pg_stat_user_indexes:
  query: |
    SELECT
      schemaname,
      relname as table_name,
      indexrelname as index_name,
      idx_scan as index_scans,
      idx_tup_read as tuples_read,
      idx_tup_fetch as tuples_fetched,
      pg_relation_size(indexrelid) as index_size_bytes
    FROM pg_stat_user_indexes
    WHERE idx_scan > 0
    ORDER BY idx_scan DESC
    LIMIT 100
  master: true
  cache_seconds: 300
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - table_name:
        usage: "LABEL"
        description: "Table name"
    - index_name:
        usage: "LABEL"
        description: "Index name"
    - index_scans:
        usage: "COUNTER"
        description: "Number of index scans"
    - tuples_read:
        usage: "COUNTER"
        description: "Number of tuples read from index"
    - tuples_fetched:
        usage: "COUNTER"
        description: "Number of tuples fetched from heap"
    - index_size_bytes:
        usage: "GAUGE"
        description: "Index size in bytes"

# =============================================================================
# Unused Indexes
# =============================================================================
pg_unused_indexes:
  query: |
    SELECT
      schemaname,
      relname as table_name,
      indexrelname as index_name,
      pg_relation_size(indexrelid) as index_size_bytes
    FROM pg_stat_user_indexes
    WHERE idx_scan = 0
      AND indexrelname NOT LIKE '%_pkey'
      AND indexrelname NOT LIKE '%_pk'
    ORDER BY pg_relation_size(indexrelid) DESC
    LIMIT 50
  master: true
  cache_seconds: 3600
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - table_name:
        usage: "LABEL"
        description: "Table name"
    - index_name:
        usage: "LABEL"
        description: "Index name"
    - index_size_bytes:
        usage: "GAUGE"
        description: "Size of unused index in bytes"

# =============================================================================
# Cache Hit Ratio
# =============================================================================
pg_stat_database_cache:
  query: |
    SELECT
      datname as database,
      blks_read,
      blks_hit,
      CASE WHEN (blks_hit + blks_read) > 0
        THEN blks_hit::float / (blks_hit + blks_read)
        ELSE 1.0
      END as cache_hit_ratio
    FROM pg_stat_database
    WHERE datname NOT IN ('template0', 'template1')
  master: true
  cache_seconds: 60
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read"
    - blks_hit:
        usage: "COUNTER"
        description: "Number of disk blocks found in buffer cache"
    - cache_hit_ratio:
        usage: "GAUGE"
        description: "Cache hit ratio (1.0 = 100% cache hits)"

# =============================================================================
# Transaction Statistics
# =============================================================================
pg_stat_database_transactions:
  query: |
    SELECT
      datname as database,
      xact_commit as commits,
      xact_rollback as rollbacks,
      CASE WHEN (xact_commit + xact_rollback) > 0
        THEN xact_rollback::float / (xact_commit + xact_rollback)
        ELSE 0.0
      END as rollback_ratio
    FROM pg_stat_database
    WHERE datname NOT IN ('template0', 'template1')
  master: true
  cache_seconds: 60
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - commits:
        usage: "COUNTER"
        description: "Number of committed transactions"
    - rollbacks:
        usage: "COUNTER"
        description: "Number of rolled back transactions"
    - rollback_ratio:
        usage: "GAUGE"
        description: "Ratio of rollbacks to total transactions"

# =============================================================================
# Replication Status (for replica monitoring)
# =============================================================================
pg_replication_slots:
  query: |
    SELECT
      slot_name,
      slot_type,
      active::int as is_active,
      pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) as lag_bytes
    FROM pg_replication_slots
    WHERE slot_type = 'physical'
  master: true
  cache_seconds: 30
  metrics:
    - slot_name:
        usage: "LABEL"
        description: "Replication slot name"
    - slot_type:
        usage: "LABEL"
        description: "Type of replication slot"
    - is_active:
        usage: "GAUGE"
        description: "Whether the slot is active (1) or not (0)"
    - lag_bytes:
        usage: "GAUGE"
        description: "Replication lag in bytes"

# =============================================================================
# Pravaha-Specific: ML Models Table
# =============================================================================
pravaha_ml_models:
  query: |
    SELECT
      COUNT(*) FILTER (WHERE status = 'active') as active_models,
      COUNT(*) FILTER (WHERE status = 'training') as training_models,
      COUNT(*) FILTER (WHERE status = 'failed') as failed_models,
      COUNT(*) as total_models
    FROM ml_models
  master: true
  cache_seconds: 60
  metrics:
    - active_models:
        usage: "GAUGE"
        description: "Number of active ML models"
    - training_models:
        usage: "GAUGE"
        description: "Number of models currently training"
    - failed_models:
        usage: "GAUGE"
        description: "Number of failed model training jobs"
    - total_models:
        usage: "GAUGE"
        description: "Total number of ML models"

# =============================================================================
# Pravaha-Specific: ML Predictions Statistics
# =============================================================================
pravaha_ml_predictions:
  query: |
    SELECT
      COUNT(*) FILTER (WHERE created_at > NOW() - INTERVAL '1 hour') as predictions_last_hour,
      COUNT(*) FILTER (WHERE created_at > NOW() - INTERVAL '24 hours') as predictions_last_24h,
      COUNT(*) as total_predictions
    FROM ml_predictions
  master: true
  cache_seconds: 60
  metrics:
    - predictions_last_hour:
        usage: "GAUGE"
        description: "Number of predictions in the last hour"
    - predictions_last_24h:
        usage: "GAUGE"
        description: "Number of predictions in the last 24 hours"
    - total_predictions:
        usage: "GAUGE"
        description: "Total number of predictions"

# =============================================================================
# Pravaha-Specific: User Activity
# =============================================================================
pravaha_user_activity:
  query: |
    SELECT
      COUNT(*) FILTER (WHERE "lastLoginAt" > NOW() - INTERVAL '1 hour') as active_users_1h,
      COUNT(*) FILTER (WHERE "lastLoginAt" > NOW() - INTERVAL '24 hours') as active_users_24h,
      COUNT(*) FILTER (WHERE "lastLoginAt" > NOW() - INTERVAL '7 days') as active_users_7d,
      COUNT(*) as total_users
    FROM users
  master: true
  cache_seconds: 300
  metrics:
    - active_users_1h:
        usage: "GAUGE"
        description: "Users active in the last hour"
    - active_users_24h:
        usage: "GAUGE"
        description: "Users active in the last 24 hours"
    - active_users_7d:
        usage: "GAUGE"
        description: "Users active in the last 7 days"
    - total_users:
        usage: "GAUGE"
        description: "Total number of users"

# =============================================================================
# Logstash Input Configuration - Filebeat Input
# Pravaha Platform Enterprise Logging
# =============================================================================

input {
  beats {
    port => 5044
    host => "0.0.0.0"

    # Connection settings
    client_inactivity_timeout => 60

    # SSL disabled for internal Docker network communication
    ssl => false

    # Add metadata
    add_field => {
      "[@metadata][pipeline]" => "pravaha"
      "[@metadata][beat]" => "filebeat"
    }
  }
}

# Initial processing and routing
filter {
  # Add processing timestamp
  ruby {
    code => "event.set('[@metadata][logstash_time]', Time.now.to_f)"
  }

  # Extract container name from Docker labels
  if [container][name] {
    mutate {
      add_field => { "pravaha_service" => "%{[container][name]}" }
    }
  }

  # Map container names to service types
  if [pravaha_service] {
    # Remove deployment-specific prefixes (e.g., "single-server-" or "pravaha-")
    mutate {
      gsub => [
        "pravaha_service", "^single-server-", "",
        "pravaha_service", "^scaled-", "",
        "pravaha_service", "^on-premise-", "",
        "pravaha_service", "^pravaha-", ""
      ]
    }

    # Normalize service names and add service_type
    if [pravaha_service] =~ /^nginx/ {
      mutate {
        replace => { "pravaha_service" => "nginx" }
        add_field => { "service_type" => "proxy" }
      }
    } else if [pravaha_service] =~ /^frontend/ {
      mutate {
        replace => { "pravaha_service" => "frontend" }
        add_field => { "service_type" => "web" }
      }
    } else if [pravaha_service] =~ /^backend/ {
      mutate {
        replace => { "pravaha_service" => "backend" }
        add_field => { "service_type" => "api" }
      }
    } else if [pravaha_service] =~ /^superset/ {
      mutate {
        replace => { "pravaha_service" => "superset" }
        add_field => { "service_type" => "analytics" }
      }
    } else if [pravaha_service] =~ /^ml-service/ {
      mutate {
        replace => { "pravaha_service" => "ml-service" }
        add_field => { "service_type" => "api" }
      }
    } else if [pravaha_service] =~ /^celery-training/ {
      mutate {
        replace => { "pravaha_service" => "celery-training" }
        add_field => { "service_type" => "worker" }
      }
    } else if [pravaha_service] =~ /^celery-prediction/ {
      mutate {
        replace => { "pravaha_service" => "celery-prediction" }
        add_field => { "service_type" => "worker" }
      }
    } else if [pravaha_service] =~ /^celery-monitoring/ {
      mutate {
        replace => { "pravaha_service" => "celery-monitoring" }
        add_field => { "service_type" => "worker" }
      }
    } else if [pravaha_service] =~ /^celery-beat/ {
      mutate {
        replace => { "pravaha_service" => "celery-beat" }
        add_field => { "service_type" => "scheduler" }
      }
    } else if [pravaha_service] =~ /^postgres/ {
      mutate {
        replace => { "pravaha_service" => "postgres" }
        add_field => { "service_type" => "database" }
      }
    } else if [pravaha_service] =~ /^redis/ {
      mutate {
        replace => { "pravaha_service" => "redis" }
        add_field => { "service_type" => "cache" }
      }
    } else {
      mutate {
        add_field => { "service_type" => "other" }
      }
    }
  }

  # Add common platform fields
  mutate {
    add_field => {
      "platform" => "pravaha"
      "environment" => "${ENVIRONMENT:production}"
    }
  }
}

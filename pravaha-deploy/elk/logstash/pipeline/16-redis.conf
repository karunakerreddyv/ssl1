# =============================================================================
# Logstash Filter - Redis Cache
# Pravaha Platform Enterprise Logging
# =============================================================================

filter {
  if [pravaha_service] == "redis" {
    # Redis log format:
    # PID:ROLE DD Mon YYYY HH:MM:SS.mmm * message
    # or: PID:ROLE DD Mon YYYY HH:MM:SS.mmm # message
    # or: PID:ROLE DD Mon YYYY HH:MM:SS.mmm - message
    grok {
      match => {
        "message" => [
          "%{POSINT:pid}:%{WORD:redis_role}\s+%{MONTHDAY}\s+%{MONTH}\s+%{YEAR}\s+%{TIME}\s*[*#.-]\s*%{GREEDYDATA:log_message}",
          "%{POSINT:pid}:%{WORD:redis_role}\s+%{GREEDYDATA:log_message}",
          "[*#.-]\s*%{GREEDYDATA:log_message}",
          "%{GREEDYDATA:log_message}"
        ]
      }
      tag_on_failure => ["_redis_grok_failure"]
    }

    # Redis uses symbols for log levels:
    # . = debug
    # - = verbose
    # * = notice (info)
    # # = warning
    # Parse log level from message prefix
    if [message] =~ /\s#\s/ {
      mutate {
        add_field => { "log_level" => "warn" }
      }
    } else if [message] =~ /\s\*\s/ {
      mutate {
        add_field => { "log_level" => "info" }
      }
    } else if [message] =~ /\s-\s/ {
      mutate {
        add_field => { "log_level" => "debug" }
      }
    } else if [message] =~ /\s\.\s/ {
      mutate {
        add_field => { "log_level" => "debug" }
      }
    } else {
      mutate {
        add_field => { "log_level" => "info" }
      }
    }

    # Detect specific Redis events
    if [log_message] =~ /Ready to accept connections/ {
      mutate {
        add_field => { "event_type" => "server_start" }
      }
    } else if [log_message] =~ /Shutdown/ or [log_message] =~ /Received SHUTDOWN/ {
      mutate {
        add_field => { "event_type" => "server_stop" }
      }
    } else if [log_message] =~ /Background saving/ or [log_message] =~ /RDB/ {
      mutate {
        add_field => { "event_type" => "persistence" }
      }
    } else if [log_message] =~ /AOF/ {
      mutate {
        add_field => { "event_type" => "aof" }
      }
    } else if [log_message] =~ /Client/ {
      mutate {
        add_field => { "event_type" => "client" }
      }
    } else if [log_message] =~ /Sentinel/ {
      mutate {
        add_field => { "event_type" => "sentinel" }
      }
    } else if [log_message] =~ /Cluster/ {
      mutate {
        add_field => { "event_type" => "cluster" }
      }
    }

    # Extract client IP from connection logs
    if [log_message] =~ /Accepted.*from/ {
      grok {
        match => { "log_message" => "from\s+(?<client_ip>[0-9.]+):(?<client_port>\d+)" }
        tag_on_failure => []
      }
      mutate {
        add_field => { "event_type" => "connection_start" }
      }
    }

    # Detect memory warnings
    if [log_message] =~ /maxmemory/ or [log_message] =~ /memory/ or [log_message] =~ /OOM/ {
      if [log_message] =~ /OOM/ or [log_message] =~ /out of memory/i {
        mutate {
          replace => { "log_level" => "error" }
          add_field => { "event_type" => "oom" }
        }
      } else {
        mutate {
          add_field => { "event_type" => "memory" }
        }
      }
    }

    # Detect slow log entries
    if [log_message] =~ /slowlog/ or [log_message] =~ /Slow query/ {
      mutate {
        add_field => { "event_type" => "slow_query" }
        replace => { "log_level" => "warn" }
      }
    }

    # Extract used memory if present
    if [log_message] =~ /used_memory/ {
      grok {
        match => { "log_message" => "used_memory[_a-z]*[=:]\s*(?<used_memory_bytes>\d+)" }
        tag_on_failure => []
      }
      if [used_memory_bytes] {
        mutate {
          convert => { "used_memory_bytes" => "integer" }
        }
      }
    }

    # Detect replication events
    if [log_message] =~ /MASTER|SLAVE|replica|replication/i {
      mutate {
        add_field => { "event_type" => "replication" }
      }
    }

    # Normalize role
    if [redis_role] {
      mutate {
        lowercase => ["redis_role"]
      }
    }

    # Convert PID to integer
    if [pid] {
      mutate {
        convert => { "pid" => "integer" }
      }
    }
  }
}

# =============================================================================
# Logstash Pipeline - Pravaha Platform Log Processing
# =============================================================================

input {
  beats {
    port => 5044
    host => "0.0.0.0"
  }
}

filter {
  # Parse Docker container metadata
  if [container][name] {
    mutate {
      add_field => { "service" => "%{[container][name]}" }
    }
  }

  # Parse JSON log messages from Pravaha services
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
      skip_on_invalid_json => true
    }
  }

  # Extract log level
  if [parsed][level] {
    mutate {
      add_field => { "log_level" => "%{[parsed][level]}" }
    }
  } else if [message] =~ /\[ERROR\]/ {
    mutate { add_field => { "log_level" => "error" } }
  } else if [message] =~ /\[WARN/ {
    mutate { add_field => { "log_level" => "warning" } }
  } else if [message] =~ /\[INFO\]/ {
    mutate { add_field => { "log_level" => "info" } }
  }

  # Tag Pravaha services
  if [container][name] =~ /^pravaha-/ {
    mutate {
      add_tag => ["pravaha"]
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["agent", "ecs", "host", "input"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "pravaha-logs"
    action => "create"
  }
}

# =============================================================================
# Logstash Filter - Apache Superset
# Pravaha Platform Enterprise Logging
# =============================================================================

filter {
  if [pravaha_service] == "superset" {
    # Attempt to parse as JSON first (Superset can output JSON logs)
    json {
      source => "message"
      target => "superset"
      skip_on_invalid_json => true
      tag_on_failure => ["_superset_json_failure"]
    }

    if [superset] {
      # Extract fields from JSON log
      if [superset][levelname] {
        mutate {
          add_field => { "log_level" => "%{[superset][levelname]}" }
        }
        mutate {
          lowercase => ["log_level"]
        }
      }

      if [superset][message] {
        mutate {
          add_field => { "log_message" => "%{[superset][message]}" }
        }
      }

      if [superset][logger] or [superset][name] {
        if [superset][logger] {
          mutate {
            add_field => { "logger_name" => "%{[superset][logger]}" }
          }
        } else {
          mutate {
            add_field => { "logger_name" => "%{[superset][name]}" }
          }
        }
      }

      if [superset][user] {
        mutate {
          add_field => { "user_id" => "%{[superset][user]}" }
        }
      }

      if [superset][dashboard_id] {
        mutate {
          add_field => { "dashboard_id" => "%{[superset][dashboard_id]}" }
        }
      }

      if [superset][chart_id] {
        mutate {
          add_field => { "chart_id" => "%{[superset][chart_id]}" }
        }
      }

      if [superset][duration] or [superset][execution_time] {
        if [superset][duration] {
          mutate {
            add_field => { "duration_ms" => "%{[superset][duration]}" }
          }
        } else {
          mutate {
            add_field => { "duration_ms" => "%{[superset][execution_time]}" }
          }
        }
        mutate {
          convert => { "duration_ms" => "float" }
        }
      }

    } else {
      # Parse Python/Flask log format
      # Format: [timestamp] LEVEL in module: message
      # Or: LEVEL:logger:message
      grok {
        match => {
          "message" => [
            "\[%{TIMESTAMP_ISO8601:log_timestamp}\]\s*%{LOGLEVEL:log_level}\s+in\s+%{DATA:logger_name}:\s*%{GREEDYDATA:log_message}",
            "%{LOGLEVEL:log_level}:%{DATA:logger_name}:%{GREEDYDATA:log_message}",
            "%{TIMESTAMP_ISO8601:log_timestamp}\s+-\s+%{DATA:logger_name}\s+-\s+%{LOGLEVEL:log_level}\s+-\s+%{GREEDYDATA:log_message}",
            "%{LOGLEVEL:log_level}\s*-\s*%{GREEDYDATA:log_message}",
            "%{GREEDYDATA:log_message}"
          ]
        }
        tag_on_failure => ["_superset_grok_failure"]
      }

      # Parse timestamp if found
      if [log_timestamp] {
        date {
          match => ["log_timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss,SSS", "yyyy-MM-dd HH:mm:ss"]
          target => "@timestamp"
          remove_field => ["log_timestamp"]
        }
      }

      if [log_level] {
        mutate {
          lowercase => ["log_level"]
        }
      } else {
        mutate {
          add_field => { "log_level" => "info" }
        }
      }
    }

    # Normalize log levels
    if [log_level] == "warning" {
      mutate {
        replace => { "log_level" => "warn" }
      }
    } else if [log_level] == "critical" {
      mutate {
        replace => { "log_level" => "error" }
      }
    }

    # Detect SQL queries
    if [message] =~ /SELECT|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER/i {
      mutate {
        add_field => { "contains_sql" => "true" }
      }
    }

    # Extract dashboard/chart IDs from URL patterns
    if [message] =~ /dashboard\/\d+/ {
      grok {
        match => { "message" => "dashboard/(?<dashboard_id>\d+)" }
        tag_on_failure => []
        overwrite => ["dashboard_id"]
      }
    }

    if [message] =~ /chart\/\d+/ or [message] =~ /explore\/\d+/ {
      grok {
        match => { "message" => "(?:chart|explore)/(?<chart_id>\d+)" }
        tag_on_failure => []
        overwrite => ["chart_id"]
      }
    }
  }
}

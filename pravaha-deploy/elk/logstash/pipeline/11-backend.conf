# =============================================================================
# Logstash Filter - Node.js Backend Service
# Pravaha Platform Enterprise Logging
# =============================================================================

filter {
  if [pravaha_service] == "backend" {
    # Attempt to parse as JSON (preferred format)
    json {
      source => "message"
      target => "backend"
      skip_on_invalid_json => true
      tag_on_failure => ["_backend_json_failure"]
    }

    # If JSON parsing succeeded, extract fields
    if [backend] {
      # Extract common fields from JSON log
      if [backend][level] {
        mutate {
          add_field => { "log_level" => "%{[backend][level]}" }
        }
        mutate {
          lowercase => ["log_level"]
        }
      }

      if [backend][message] {
        mutate {
          add_field => { "log_message" => "%{[backend][message]}" }
        }
      }

      if [backend][requestId] {
        mutate {
          add_field => { "request_id" => "%{[backend][requestId]}" }
        }
      }

      if [backend][userId] {
        mutate {
          add_field => { "user_id" => "%{[backend][userId]}" }
        }
      }

      if [backend][tenantId] {
        mutate {
          add_field => { "tenant_id" => "%{[backend][tenantId]}" }
        }
      }

      if [backend][duration] {
        mutate {
          add_field => { "duration_ms" => "%{[backend][duration]}" }
        }
        mutate {
          convert => { "duration_ms" => "float" }
        }
      }

      if [backend][method] {
        mutate {
          add_field => { "http_method" => "%{[backend][method]}" }
        }
      }

      if [backend][path] or [backend][url] {
        if [backend][path] {
          mutate {
            add_field => { "request_path" => "%{[backend][path]}" }
          }
        } else {
          mutate {
            add_field => { "request_path" => "%{[backend][url]}" }
          }
        }
      }

      if [backend][statusCode] {
        mutate {
          add_field => { "http_status" => "%{[backend][statusCode]}" }
        }
        mutate {
          convert => { "http_status" => "integer" }
        }
      }

      if [backend][error] {
        mutate {
          add_field => { "error_message" => "%{[backend][error]}" }
        }
      }

      if [backend][stack] {
        mutate {
          add_field => { "stack_trace" => "%{[backend][stack]}" }
        }
      }

      # Parse timestamp from log if present
      if [backend][timestamp] {
        date {
          match => ["[backend][timestamp]", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
          target => "@timestamp"
        }
      }

    } else {
      # Fallback: Parse plain text logs
      # Pattern: [LEVEL] timestamp - message
      grok {
        match => {
          "message" => [
            "\[%{LOGLEVEL:log_level}\]\s*%{TIMESTAMP_ISO8601:log_timestamp}\s*-?\s*%{GREEDYDATA:log_message}",
            "%{LOGLEVEL:log_level}:\s*%{GREEDYDATA:log_message}",
            "%{GREEDYDATA:log_message}"
          ]
        }
        tag_on_failure => ["_backend_grok_failure"]
      }

      if [log_level] {
        mutate {
          lowercase => ["log_level"]
        }
      } else {
        mutate {
          add_field => { "log_level" => "info" }
        }
      }

      # Parse timestamp if found
      if [log_timestamp] {
        date {
          match => ["log_timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss"]
          target => "@timestamp"
          remove_field => ["log_timestamp"]
        }
      }
    }

    # Normalize log levels
    if [log_level] == "warn" or [log_level] == "warning" {
      mutate {
        replace => { "log_level" => "warn" }
      }
    } else if [log_level] == "err" {
      mutate {
        replace => { "log_level" => "error" }
      }
    } else if [log_level] == "verbose" or [log_level] == "trace" or [log_level] == "silly" {
      mutate {
        replace => { "log_level" => "debug" }
      }
    }

    # Extract request ID from message if not already present
    if ![request_id] and [message] =~ /requestId/ {
      grok {
        match => { "message" => "requestId[\":\s]+(?<request_id>[a-f0-9-]{36})" }
        tag_on_failure => []
      }
    }
  }
}

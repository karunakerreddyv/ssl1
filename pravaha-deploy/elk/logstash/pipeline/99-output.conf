# =============================================================================
# Logstash Output Configuration - Elasticsearch
# Pravaha Platform Enterprise Logging
# =============================================================================

output {
  # Primary output to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
    user => "${ELASTICSEARCH_USERNAME:elastic}"
    password => "${ELASTIC_PASSWORD}"

    # Index naming with daily rotation
    # Format: pravaha-logs-YYYY.MM.DD
    index => "pravaha-logs-%{+YYYY.MM.DD}"

    # Use ILM for lifecycle management
    ilm_enabled => true
    ilm_rollover_alias => "pravaha-logs"
    ilm_pattern => "{now/d}-000001"
    ilm_policy => "pravaha-logs-policy"

    # Template configuration
    template_name => "pravaha-logs"
    template_overwrite => true

    # Action for each document
    action => "create"

    # Retry on conflict
    retry_on_conflict => 1

    # Document ID (auto-generated for uniqueness)
    # document_id => "%{[@metadata][_id]}"

    # Pipeline for ingest node processing (optional)
    # pipeline => "pravaha-ingest-pipeline"

    # SSL configuration (disabled for internal Docker network)
    ssl => false

    # Connection settings
    timeout => 60
    pool_max => 10
    pool_max_per_route => 5

    # Bulk settings for performance
    flush_size => 500
    idle_flush_time => 1

    # Sniffing disabled for single-node
    sniffing => false

    # Healthcheck
    healthcheck_path => "/"
    resurrect_delay => 5
  }

  # Debug output (uncomment for troubleshooting)
  # stdout {
  #   codec => rubydebug
  # }

  # Dead letter queue for failed events
  # Events that fail to index will be stored here
}

# Conditional outputs for specific services (optional routing)
# output {
#   if [pravaha_service] == "nginx" and [log_level] == "error" {
#     # Send NGINX errors to a separate index for alerting
#     elasticsearch {
#       hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
#       user => "${ELASTICSEARCH_USERNAME:elastic}"
#       password => "${ELASTIC_PASSWORD}"
#       index => "pravaha-alerts-%{+YYYY.MM.DD}"
#       ssl => false
#     }
#   }
# }
